<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><link href=https://guylewin.com/rss.xml rel=alternate title=RSS type=application/rss+xml><title>Guy Lewin's Blog | Bathroom Smart Speaker Part 2 - AirPlay to Bluetooth Speaker via Raspberry Pi</title><link as=style href=https://guylewin.com/css/style.css rel=preload><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/reset-min.css rel=stylesheet><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/suCSS-min.css rel=stylesheet><link href=https://guylewin.com/css/style.css rel=stylesheet><link href=https://guylewin.com/css/custom.css rel=stylesheet><link href=https://guylewin.com/favicon.ico rel=icon><script src="https://www.googletagmanager.com/gtag/js?id=G-YEJ89F03YG" async></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-YEJ89F03YG');</script><meta content="Adding AirPlay support to a smart speaker setup using shairport-sync, allowing Apple Music streaming and multi-room audio capabilities alongside existing Spotify Connect functionality." name=description><meta content="Adding AirPlay support to a smart speaker setup using shairport-sync, allowing Apple Music streaming and multi-room audio capabilities alongside existing Spotify Connect functionality." property=og:description><meta content="Adding AirPlay support to a smart speaker setup using shairport-sync, allowing Apple Music streaming and multi-room audio capabilities alongside existing Spotify Connect functionality." name=twitter:description><meta content="airplay, apple music, bluetooth, home assistant, raspberry pi, shairport-sync, spotify, ue boom" name=keywords><meta content=Zola name=generator><meta content=English name=language><meta content="index, follow" name=robots><meta content="index, follow" name=googlebot><meta content=en_US property=og:locale><meta content="Guy Lewin's Blog" property=og:site_name><meta content="Guy Lewin's Blog | Bathroom Smart Speaker Part 2 - AirPlay to Bluetooth Speaker via Raspberry Pi" property=og:title><meta content=https://guylewin.com/blog/2022-03-02-bathroom-smart-speaker-part-2-airplay-to-bluetooth-speaker-via-raspberry-pi/ property=og:url><meta content=article property=og:type><meta content=summary_large_image name=twitter:card><meta content="Guy Lewin's Blog | Bathroom Smart Speaker Part 2 - AirPlay to Bluetooth Speaker via Raspberry Pi" name=twitter:title><link href=https://guylewin.com/blog/2022-03-02-bathroom-smart-speaker-part-2-airplay-to-bluetooth-speaker-via-raspberry-pi/ rel=canonical><meta content="Guy Lewin" name=author><meta content="Guy Lewin" property=og:author><meta content=2022-03-02T00:00:00Z property=article:published_time><meta content="Guy Lewin" property=article:author><meta content=Blog property=article:section><meta content=airplay property=article:tag><meta content="apple music" property=article:tag><meta content=bluetooth property=article:tag><meta content="home assistant" property=article:tag><meta content="raspberry pi" property=article:tag><meta content=shairport-sync property=article:tag><meta content=spotify property=article:tag><meta content="ue boom" property=article:tag><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "Bathroom Smart Speaker Part 2 - AirPlay to Bluetooth Speaker via Raspberry Pi",
    
    "author": {
        "@type": "Person",
        "name": "Guy Lewin"
    },
    
    
    "datePublished": "2022-03-02",
    
    "description": "Adding AirPlay support to a smart speaker setup using shairport-sync, allowing Apple Music streaming and multi-room audio capabilities alongside existing Spotify Connect functionality.",
    "publisher": {
        "@type": "Organization",
        "name": "Guy Lewin&#x27;s Blog"
    }
}
</script><body><nav id=nav-bar><div class=nav-social><a class=icon-link href=https://www.threads.com/@guylewin target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#threads></use></svg></a><a class=icon-link href=https://www.linkedin.com/in/guy-lewin-48b00712 target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#linkedin></use></svg></a><a class=icon-link href=https://github.com/GuyLewin target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#github></use></svg></a><a class=icon-link href=mailto:contact@guylewin.com target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#email></use></svg></a></div><div class=nav-menu><a href=/> /blog/ </a><a href=/about> /about/ </a></div><div class=nav-controls><div aria-label="Toggle theme" class=theme-toggle data-icon-base=https://guylewin.com/icons.svg data-icon-dark=#darkMode data-icon-light=#lightMode data-sound-src=https://guylewin.com/click.ogg id=theme-toggle role=button tabindex=0><svg class=icon><use id=theme-icon></use></svg></div></div></nav><main><article class=post><header class=post-header><time datetime=2022-03-02>Published on: <span class=accent-data>2022-03-02</span> </time><address rel=author>By <span class=accent-data>Guy Lewin</span></address><h1>Bathroom Smart Speaker Part 2 - AirPlay to Bluetooth Speaker via Raspberry Pi</h1></header><div class=post-content><p>In <a rel="noopener external" href=https://lewin.co.il/bathroom-smart-speaker-using-ue-boom-raspberry-pi-spotify-and-home-assistant/ target=_blank>part 1</a> I wrote on how to create a smart speaker supporting Spotify Connect using a Raspberry Pi and a Bluetooth speaker. Since writing that post I started using Apple Music and wanted to enjoy simultaneous streaming of music to multiple speakers in my house. I wanted my bathroom speaker, which became smart by supporting Spotify Connect, to also be able to play Apple Music.<p>Apple Music casting uses <a rel="noopener external" href=https://www.apple.com/airplay/ target=_blank>AirPlay</a> for casting audio between devices. It can be used to cast any sound from Apple devices, even when using Spotify, watching YouTube or having a phone call.<p>In order to add this capability to your smart speaker from the previous post - we’re going to use <a rel="noopener external" href=https://github.com/mikebrady/shairport-sync target=_blank>shairport-sync</a>, which is an open-source audio player supporting AirPlay 1 (and AirPlay 2 partially, at the time of writing this post). The instructions in this post are partially based on <a rel="noopener external" href=https://github.com/mikebrady/shairport-sync/issues/200#issuecomment-520574102 target=_blank>this GitHub comment by <code>bedrin</code></a>.<h2 id=steps>Steps</h2><h3 id=installing-shairport-sync>Installing shairport-sync</h3><p>Execute the following commands from to install the most recent version of shairport-sync:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=shellscript><span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> apt-get update</span></span>
<span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> apt-get install build-essential git xmltoman autoconf automake libtool libpopt-dev libconfig-dev libasound2-dev avahi-daemon libavahi-client-dev libssl-dev libsoxr-dev</span></span>
<span class=giallo-l><span style=color:#b392f0>git</span><span style=color:#9ecbff> clone https://github.com/mikebrady/shairport-sync.git</span></span>
<span class=giallo-l><span style=color:#79b8ff>cd</span><span style=color:#9ecbff> shairport-sync</span></span>
<span class=giallo-l><span style=color:#b392f0>autoreconf</span><span style=color:#79b8ff> -fi</span></span>
<span class=giallo-l><span style=color:#b392f0>./configure</span><span style=color:#79b8ff> --sysconfdir=/etc --with-alsa --with-soxr --with-avahi --with-ssl=openssl --with-systemd</span></span>
<span class=giallo-l><span style=color:#b392f0>make</span></span>
<span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> make install</span></span></code></pre><h3 id=giving-shairport-sync-bluetooth-permissions>Giving shairport-sync Bluetooth Permissions</h3><p>shairport-sync needs permissions to play sound over Bluetooth. Run these commands to add shairport-sync’s user (and <code>pi</code> for testing purposes) to the Bluetooth UNIX group which will permit it to play audio:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=shellscript><span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> adduser pi bluetooth</span></span>
<span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> adduser shairport-sync bluetooth</span></span></code></pre><h3 id=adding-additional-alsa-device>Adding Additional ALSA Device</h3><p>In the previous post we edited <code>/etc/asound.conf</code> to point to the Bluetooth speaker as the default device. shairport-sync requires a named device, so we’ll create another ALSA device alongside the default one to also map to the Bluetooth speaker.<p>Open <code>/etc/asound.conf</code> and copy the MAC address you filled after <code>defaults.bluealsa.device</code> (should be at line 4 in quotation marks). Replace the content of <code>/etc/asound.conf</code> with the following, while replacing <code>&lt;UE Boom Bluetooth MAC></code> with the MAC address you found in line 4:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=plain><span class=giallo-l><span>pcm.!default "bluealsa"</span></span>
<span class=giallo-l><span>ctl.!default "bluealsa"</span></span>
<span class=giallo-l><span>defaults.bluealsa.interface "hci0"</span></span>
<span class=giallo-l><span>defaults.bluealsa.device "&lt;UE Boom Bluetooth MAC>"</span></span>
<span class=giallo-l><span>defaults.bluealsa.profile "a2dp"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>pcm.bathroom_bt {</span></span>
<span class=giallo-l><span> type plug</span></span>
<span class=giallo-l><span>  slave {</span></span>
<span class=giallo-l><span>    pcm {</span></span>
<span class=giallo-l><span>      type bluealsa</span></span>
<span class=giallo-l><span>      device "&lt;UE Boom Bluetooth MAC>"</span></span>
<span class=giallo-l><span>      profile "a2dp"</span></span>
<span class=giallo-l><span>    }</span></span>
<span class=giallo-l><span>  }</span></span>
<span class=giallo-l><span>  hint {</span></span>
<span class=giallo-l><span>    show on</span></span>
<span class=giallo-l><span>    description "Bathroom BT"</span></span>
<span class=giallo-l><span>  }</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>In the above configuration I named this device "bathroom_bt" (line 7) with the description "Bathroom BT". You can replace this to fit your scenario, but make sure to replace it in the below shairport-sync configuration as well.<h3 id=shairport-sync-configuration>shairport-sync Configuration</h3><p>Now that the ALSA device is configured - we should configure shairport-sync to use this device as the sound output device. Replace the content of <code>/etc/shairport-sync.conf</code> with the following:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=plain><span class=giallo-l><span>general =</span></span>
<span class=giallo-l><span>{</span></span>
<span class=giallo-l><span>	name = "Bathroom Speaker";</span></span>
<span class=giallo-l><span>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>sessioncontrol =</span></span>
<span class=giallo-l><span>{</span></span>
<span class=giallo-l><span>	allow_session_interruption = "yes";</span></span>
<span class=giallo-l><span>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>alsa =</span></span>
<span class=giallo-l><span>{</span></span>
<span class=giallo-l><span>	output_device = "bathroom_bt";</span></span>
<span class=giallo-l><span>};</span></span></code></pre><p>The <code>name</code> parameter under <code>general</code> (line 3) will be the displayed AirPlay name, set it to a suitable value. If you changed the name of the ALSA device (in <code>/etc/asound.conf</code> at line 7) change it under <code>output_device</code> at line 13 as well.<h3 id=disable-wifi-power-management>Disable WiFi Power Management</h3><p>Raspberry Pi’s WiFi can sometimes goes into power-saving mode, which can cause audio drops and glitches when acting as an AirPlay server. We can disable the WiFi power management by editing <code>/etc/rc.local</code> and adding the following line right before <code>exit 0</code> (if you followed my previous post - this should be at line 19):<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=shellscript><span class=giallo-l><span style=color:#b392f0>iwconfig</span><span style=color:#9ecbff> wlan0 power off</span></span></code></pre><p>After adding this line, your <code>/etc/rc.local</code> should look like this:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=shellscript><span class=giallo-l><span style=color:#6a737d>#!/bin/sh -e</span></span>
<span class=giallo-l><span style=color:#6a737d>#</span></span>
<span class=giallo-l><span style=color:#6a737d># rc.local</span></span>
<span class=giallo-l><span style=color:#6a737d>#</span></span>
<span class=giallo-l><span style=color:#6a737d># This script is executed at the end of each multiuser runlevel.</span></span>
<span class=giallo-l><span style=color:#6a737d># Make sure that the script will "exit 0" on success or any other</span></span>
<span class=giallo-l><span style=color:#6a737d># value on error.</span></span>
<span class=giallo-l><span style=color:#6a737d>#</span></span>
<span class=giallo-l><span style=color:#6a737d># In order to enable or disable this script just change the execution</span></span>
<span class=giallo-l><span style=color:#6a737d># bits.</span></span>
<span class=giallo-l><span style=color:#6a737d>#</span></span>
<span class=giallo-l><span style=color:#6a737d># By default this script does nothing.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># Print the IP address</span></span>
<span class=giallo-l><span>_IP</span><span style=color:#f97583>=</span><span>$(</span><span style=color:#b392f0>hostname</span><span style=color:#79b8ff> -I</span><span>)</span><span style=color:#f97583> ||</span><span style=color:#79b8ff> true</span></span>
<span class=giallo-l><span style=color:#f97583>if</span><span> [</span><span style=color:#9ecbff> "</span><span>$_IP</span><span style=color:#9ecbff>"</span><span> ];</span><span style=color:#f97583> then</span></span>
<span class=giallo-l><span style=color:#79b8ff>  printf</span><span style=color:#9ecbff> "My IP address is %s\n" "</span><span>$_IP</span><span style=color:#9ecbff>"</span></span>
<span class=giallo-l><span style=color:#f97583>fi</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#b392f0>iwconfig</span><span style=color:#9ecbff> wlan0 power off</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#79b8ff>exit 0</span></span></code></pre><h3 id=enable-shairport-sync-service>Enable shairport-sync Service</h3><p>Finalize your setup by enabling the <code>shairport-sync</code> service and performing a system reboot to load all the new configurations:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=shellscript><span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> systemctl enable shairport-sync</span></span>
<span class=giallo-l><span style=color:#b392f0>sudo</span><span style=color:#9ecbff> reboot</span></span></code></pre></div><div class=post-tags><a class=tag href=/tags/airplay>#airplay</a><a class=tag href=/tags/apple-music>#apple music</a><a class=tag href=/tags/bluetooth>#bluetooth</a><a class=tag href=/tags/home-assistant>#home assistant</a><a class=tag href=/tags/raspberry-pi>#raspberry pi</a><a class=tag href=/tags/shairport-sync>#shairport-sync</a><a class=tag href=/tags/spotify>#spotify</a><a class=tag href=/tags/ue-boom>#ue boom</a></div><div class=post-nav><a class=previous href=https://guylewin.com/blog/2022-04-17-thcon-2k22-ctf-local-card-maker-writeup/><svg class=icon><use href=https://guylewin.com/icons.svg#chevronLeft></use></svg> Next Project</a><a class=next href=https://guylewin.com/blog/2021-12-27-winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/>Previous Project <svg class=icon><use href=https://guylewin.com/icons.svg#chevronRight></use></svg></a></div></article></main><footer><hr><div id=footer-container><p>Made using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> Zola theme</div></footer><script defer src=https://guylewin.com/js/script.js></script>